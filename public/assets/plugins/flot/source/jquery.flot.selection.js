(function($){function init(plot){var selection={first:{x:-1,y:-1},second:{x:-1,y:-1},show:false,currentMode:'xy',active:false};var SNAPPING_CONSTANT=$.plot.uiConstants.SNAPPING_CONSTANT;var savedhandlers={};function onDrag(e){if(selection.active){updateSelection(e);plot.getPlaceholder().trigger("plotselecting",[getSelection()]);}}
function onDragStart(e){var o=plot.getOptions();if(e.which!==1||o.selection.mode===null)return;selection.currentMode='xy';document.body.focus();if(document.onselectstart!==undefined&&savedhandlers.onselectstart==null){savedhandlers.onselectstart=document.onselectstart;document.onselectstart=function(){return false;};}
if(document.ondrag!==undefined&&savedhandlers.ondrag==null){savedhandlers.ondrag=document.ondrag;document.ondrag=function(){return false;};}
setSelectionPos(selection.first,e);selection.active=true;}
function onDragEnd(e){if(document.onselectstart!==undefined){document.onselectstart=savedhandlers.onselectstart;}
if(document.ondrag!==undefined){document.ondrag=savedhandlers.ondrag;}
selection.active=false;updateSelection(e);if(selectionIsSane()){triggerSelectedEvent();}else{plot.getPlaceholder().trigger("plotunselected",[]);plot.getPlaceholder().trigger("plotselecting",[null]);}
return false;}
function getSelection(){if(!selectionIsSane())return null;if(!selection.show)return null;var r={},c1={x:selection.first.x,y:selection.first.y},c2={x:selection.second.x,y:selection.second.y};if(selectionDirection(plot)==='x'){c1.y=0;c2.y=plot.height();}
if(selectionDirection(plot)==='y'){c1.x=0;c2.x=plot.width();}
$.each(plot.getAxes(),function(name,axis){if(axis.used){var p1=axis.c2p(c1[axis.direction]),p2=axis.c2p(c2[axis.direction]);r[name]={from:Math.min(p1,p2),to:Math.max(p1,p2)};}});return r;}
function triggerSelectedEvent(){var r=getSelection();plot.getPlaceholder().trigger("plotselected",[r]);if(r.xaxis&&r.yaxis){plot.getPlaceholder().trigger("selected",[{x1:r.xaxis.from,y1:r.yaxis.from,x2:r.xaxis.to,y2:r.yaxis.to}]);}}
function clamp(min,value,max){return value<min?min:(value>max?max:value);}
function selectionDirection(plot){var o=plot.getOptions();if(o.selection.mode==='smart'){return selection.currentMode;}else{return o.selection.mode;}}
function updateMode(pos){if(selection.first){var delta={x:pos.x-selection.first.x,y:pos.y-selection.first.y};if(Math.abs(delta.x)<SNAPPING_CONSTANT){selection.currentMode='y';}else if(Math.abs(delta.y)<SNAPPING_CONSTANT){selection.currentMode='x';}else{selection.currentMode='xy';}}}
function setSelectionPos(pos,e){var offset=plot.getPlaceholder().offset();var plotOffset=plot.getPlotOffset();pos.x=clamp(0,e.pageX-offset.left-plotOffset.left,plot.width());pos.y=clamp(0,e.pageY-offset.top-plotOffset.top,plot.height());if(pos!==selection.first)updateMode(pos);if(selectionDirection(plot)==="y"){pos.x=pos===selection.first?0:plot.width();}
if(selectionDirection(plot)==="x"){pos.y=pos===selection.first?0:plot.height();}}
function updateSelection(pos){if(pos.pageX==null)return;setSelectionPos(selection.second,pos);if(selectionIsSane()){selection.show=true;plot.triggerRedrawOverlay();}else clearSelection(true);}
function clearSelection(preventEvent){if(selection.show){selection.show=false;selection.currentMode='';plot.triggerRedrawOverlay();if(!preventEvent){plot.getPlaceholder().trigger("plotunselected",[]);}}}
function extractRange(ranges,coord){var axis,from,to,key,axes=plot.getAxes();for(var k in axes){axis=axes[k];if(axis.direction===coord){key=coord+axis.n+"axis";if(!ranges[key]&&axis.n===1){key=coord+"axis";}
if(ranges[key]){from=ranges[key].from;to=ranges[key].to;break;}}}
if(!ranges[key]){axis=coord==="x"?plot.getXAxes()[0]:plot.getYAxes()[0];from=ranges[coord+"1"];to=ranges[coord+"2"];}
if(from!=null&&to!=null&&from>to){var tmp=from;from=to;to=tmp;}
return{from:from,to:to,axis:axis};}
function setSelection(ranges,preventEvent){var range;if(selectionDirection(plot)==="y"){selection.first.x=0;selection.second.x=plot.width();}else{range=extractRange(ranges,"x");selection.first.x=range.axis.p2c(range.from);selection.second.x=range.axis.p2c(range.to);}
if(selectionDirection(plot)==="x"){selection.first.y=0;selection.second.y=plot.height();}else{range=extractRange(ranges,"y");selection.first.y=range.axis.p2c(range.from);selection.second.y=range.axis.p2c(range.to);}
selection.show=true;plot.triggerRedrawOverlay();if(!preventEvent&&selectionIsSane()){triggerSelectedEvent();}}
function selectionIsSane(){var minSize=plot.getOptions().selection.minSize;return Math.abs(selection.second.x-selection.first.x)>=minSize&&Math.abs(selection.second.y-selection.first.y)>=minSize;}
plot.clearSelection=clearSelection;plot.setSelection=setSelection;plot.getSelection=getSelection;plot.hooks.bindEvents.push(function(plot,eventHolder){var o=plot.getOptions();if(o.selection.mode!=null){plot.addEventHandler("dragstart",onDragStart,eventHolder,0);plot.addEventHandler("drag",onDrag,eventHolder,0);plot.addEventHandler("dragend",onDragEnd,eventHolder,0);}});function drawSelectionDecorations(ctx,x,y,w,h,oX,oY,mode){var spacing=3;var fullEarWidth=15;var earWidth=Math.max(0,Math.min(fullEarWidth,w/2-2,h/2-2));ctx.fillStyle='#ffffff';if(mode==='xy'){ctx.beginPath();ctx.moveTo(x,y+earWidth);ctx.lineTo(x-3,y+earWidth);ctx.lineTo(x-3,y-3);ctx.lineTo(x+earWidth,y-3);ctx.lineTo(x+earWidth,y);ctx.lineTo(x,y);ctx.closePath();ctx.moveTo(x,y+h-earWidth);ctx.lineTo(x-3,y+h-earWidth);ctx.lineTo(x-3,y+h+3);ctx.lineTo(x+earWidth,y+h+3);ctx.lineTo(x+earWidth,y+h);ctx.lineTo(x,y+h);ctx.closePath();ctx.moveTo(x+w,y+earWidth);ctx.lineTo(x+w+3,y+earWidth);ctx.lineTo(x+w+3,y-3);ctx.lineTo(x+w-earWidth,y-3);ctx.lineTo(x+w-earWidth,y);ctx.lineTo(x+w,y);ctx.closePath();ctx.moveTo(x+w,y+h-earWidth);ctx.lineTo(x+w+3,y+h-earWidth);ctx.lineTo(x+w+3,y+h+3);ctx.lineTo(x+w-earWidth,y+h+3);ctx.lineTo(x+w-earWidth,y+h);ctx.lineTo(x+w,y+h);ctx.closePath();ctx.stroke();ctx.fill();}
x=oX;y=oY;if(mode==='x'){ctx.beginPath();ctx.moveTo(x,y+fullEarWidth);ctx.lineTo(x,y-fullEarWidth);ctx.lineTo(x-spacing,y-fullEarWidth);ctx.lineTo(x-spacing,y+fullEarWidth);ctx.closePath();ctx.moveTo(x+w,y+fullEarWidth);ctx.lineTo(x+w,y-fullEarWidth);ctx.lineTo(x+w+spacing,y-fullEarWidth);ctx.lineTo(x+w+spacing,y+fullEarWidth);ctx.closePath();ctx.stroke();ctx.fill();}
if(mode==='y'){ctx.beginPath();ctx.moveTo(x-fullEarWidth,y);ctx.lineTo(x+fullEarWidth,y);ctx.lineTo(x+fullEarWidth,y-spacing);ctx.lineTo(x-fullEarWidth,y-spacing);ctx.closePath();ctx.moveTo(x-fullEarWidth,y+h);ctx.lineTo(x+fullEarWidth,y+h);ctx.lineTo(x+fullEarWidth,y+h+spacing);ctx.lineTo(x-fullEarWidth,y+h+spacing);ctx.closePath();ctx.stroke();ctx.fill();}}
plot.hooks.drawOverlay.push(function(plot,ctx){if(selection.show&&selectionIsSane()){var plotOffset=plot.getPlotOffset();var o=plot.getOptions();ctx.save();ctx.translate(plotOffset.left,plotOffset.top);var c=$.color.parse(o.selection.color);var visualization=o.selection.visualization;var displaySelectionDecorations=o.selection.displaySelectionDecorations;var scalingFactor=1;if(visualization==="fill"){scalingFactor=0.8;}
ctx.strokeStyle=c.scale('a',scalingFactor).toString();ctx.lineWidth=1;ctx.lineJoin=o.selection.shape;ctx.fillStyle=c.scale('a',0.4).toString();var x=Math.min(selection.first.x,selection.second.x)+0.5,oX=x,y=Math.min(selection.first.y,selection.second.y)+0.5,oY=y,w=Math.abs(selection.second.x-selection.first.x)-1,h=Math.abs(selection.second.y-selection.first.y)-1;if(selectionDirection(plot)==='x'){h+=y;y=0;}
if(selectionDirection(plot)==='y'){w+=x;x=0;}
if(visualization==="fill"){ctx.fillRect(x,y,w,h);ctx.strokeRect(x,y,w,h);}else{ctx.fillRect(0,0,plot.width(),plot.height());ctx.clearRect(x,y,w,h);if(displaySelectionDecorations){drawSelectionDecorations(ctx,x,y,w,h,oX,oY,selectionDirection(plot));}}
ctx.restore();}});plot.hooks.shutdown.push(function(plot,eventHolder){eventHolder.unbind("dragstart",onDragStart);eventHolder.unbind("drag",onDrag);eventHolder.unbind("dragend",onDragEnd);});}
$.plot.plugins.push({init:init,options:{selection:{mode:null,visualization:"focus",displaySelectionDecorations:true,color:"#888888",shape:"round",minSize:5}},name:'selection',version:'1.1'});})(jQuery);